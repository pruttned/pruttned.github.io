{"componentChunkName":"component---src-templates-blog-page-js","path":"/blog/my-first-post","result":{"data":{"markdownRemark":{"html":"<p>Today when you are creating an application, you have many options for a\ndatabase to choose from.\nWhat you might not realize is that you could consider Git as one of the\noptions with some great advantages. Why and how would you do that? Well,\nread ahead.</p>\n<!-- end -->\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span><span class=\"token function\"> getDocument</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">collection<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">:</span> string</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Promise<span class=\"token operator\">&lt;</span>any<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> documentCacheKey <span class=\"token operator\">=</span><span class=\"token function\"> getDocumentCacheKey</span><span class=\"token punctuation\">(</span>collection<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> document <span class=\"token operator\">=</span> documentCache<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>documentCacheKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token function\"> </span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">!</span>document</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> file <span class=\"token operator\">=</span><span class=\"token function\"> getDocumentPath</span><span class=\"token punctuation\">(</span>collection<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> fileContent <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span><span class=\"token function\"> readFile</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">,</span> <span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        document <span class=\"token operator\">=</span> yaml<span class=\"token punctuation\">.</span><span class=\"token function\">safeLoad</span><span class=\"token punctuation\">(</span>fileContent<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">        </span><span class=\"token punctuation\">(</span>document <span class=\"token keyword\">as</span> any<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> id<span class=\"token punctuation\">;</span>\n        documentCache<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>documentCacheKey<span class=\"token punctuation\">,</span> document<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> document<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span><span class=\"token function\"> getDocumentCacheKey</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">collection<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">:</span> string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>collection<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">-</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span><span class=\"token function\"> getDocumentPath</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">collection<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">:</span> string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>baseDir<span class=\"token punctuation\">,</span> collection<span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.yaml</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Recently I was creating a simple invoicing application with my brother\nas a personal project for our needs. From the very beginning, we\nintended to run our application locally in a single-user mode, but we\nrequired to be able to access data from multiple places.</p>\n<p>In the past, we discussed the possibilities of using file system along\nwith Git to create a simple, yet powerful database, so we decided to use\nthis opportunity to make a proof of concept of this idea. </p>\n<h2>Why Git?</h2>\n<p>Let's look at the benefits of using Git backed filesystem as an\napplication database.</p>\n<ul>\n<li>History - Let<code class=\"language-text\">s face it, managing history in common database is\nusually not fun. You</code>ll end up with tables full of records where\nyou must check dates just to get the currently active record. Or\nyou must move records to historical tables. Either way, it is\ntedious. But with Git, you`ll get history basically for free. You\nare even able to compare versions, and you also know who, when,\nand why did the change.</li>\n<li>Hosting for free -- Today, you can create a private repo in\nBitbucket and Github without any costs. Compared to ordinary\ndatabase free hostings, there are no row constraints, no\nread/write constraints, and I consider both Github and Bitbucket\nreliable providers.</li>\n<li>Human readable data store - By storing data in plain text files, you\ncan read and even edit data with your favorite text editor. Thanks\nto this, you can quickly hack some data, or rapidly prototype new\nfeatures. E.g., you need to clone an old invoice, and you still\nhad no time to implement this feature into your application? No\nproblem, simply copy the file, open your favorite text editor, and\nyou are done. It`s much easier than in most database admin tools.</li>\n<li>Distributed and disconnected database - Great thing about Git is its\ndistributed nature. Each local repository contains the full\nhistory. If one of the repositories dies, it doesn't usually mean\na loss of data. It is also possible to work in offline mode\nwithout any additional headaches.</li>\n<li>Merging of conflicts - When two users change the same entity, there\nmust be a conflict resolution. That often means that either the\nlater change wins or the first one. Git, on the other hand, gives\nusers the ability to merge conflicts manually and in many cases,\ncan merge changes automatically.</li>\n</ul>\n<p>Now, when we know what the benefits of a Git application database are,\nlet us dive into implementation.</p>\n<h2>How to store documents</h2>\n<p>First, we need to decide how we are going to model our database. We will\nuse folders for collections and files for documents.</p>\n<p><img src=\"./aa/media/image1.png\">{width=\"5.458805774278215in\"\nheight=\"2.2418613298337706in\"}</p>\n<p>This way, it is easy to collect all the entities stored in one\ncollection, and it is also more readable for a human. We are going to\nuse a non-bare repository, so we will be able to access files directly,\nwhich I consider to be a big advantage.</p>\n<p>Let`s point out here an interesting article\n<a href=\"https://www.kenneth-truyers.net/2016/10/13/git-nosql-database/\" target=\"_blank\" rel=\"nofollow noopener\">[https://www.kenneth-truyers.net/2016/10/13/git-nosql-database/]{.underline}</a>\nthat is also dealing with the concept of using Git as a database, but\ninstead is using bare repositories.</p>\n<p>To speed up lookups, we are going to store document ID directly in the\nfile name. This way, it is not necessary to open a file to get the ID.\nAnd it is again more readable for a human. It would also be possible to\nstore more fields in the file name and thus make a sort of index.</p>\n<p>As a file format for document files, we will use YAML. YAML is great for\nserializing data while keeping them human-readable, so checking diffs in\nthe Git history will be easier for us.</p>\n<h2>Let`s have some performance</h2>\n<p>Ok, so now when we have our file structure, to have any sense of speed,\nwe need caching. We are going to do caching on two levels. First, we\nwill cache collection and then also individual documents.</p>\n<p>Caching of individual documents is more interesting, so let us start\nwith that. We should better not keep documents in memory forever, but\nrather they should have TTL (time to live) specified. For actual\nimplementation, we will use node-cache\n(<a href=\"https://www.npmjs.com/package/node-cache\" target=\"_blank\" rel=\"nofollow noopener\">https://www.npmjs.com/package/node-cache</a>) library.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span><span class=\"token function\"> getDocument</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">collection<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">:</span> string</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Promise<span class=\"token operator\">&lt;</span>any<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> documentCacheKey <span class=\"token operator\">=</span><span class=\"token function\"> getDocumentCacheKey</span><span class=\"token punctuation\">(</span>collection<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">let</span> document <span class=\"token operator\">=</span> documentCache<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>documentCacheKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token function\"> </span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">!</span>document</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> file <span class=\"token operator\">=</span><span class=\"token function\"> getDocumentPath</span><span class=\"token punctuation\">(</span>collection<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> fileContent <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span><span class=\"token function\"> readFile</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">,</span> <span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        document <span class=\"token operator\">=</span> yaml<span class=\"token punctuation\">.</span><span class=\"token function\">safeLoad</span><span class=\"token punctuation\">(</span>fileContent<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token function\">        </span><span class=\"token punctuation\">(</span>document <span class=\"token keyword\">as</span> any<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> id<span class=\"token punctuation\">;</span>\n        documentCache<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>documentCacheKey<span class=\"token punctuation\">,</span> document<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> document<span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span><span class=\"token function\"> getDocumentCacheKey</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">collection<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">:</span> string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>collection<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">-</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span><span class=\"token function\"> getDocumentPath</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">collection<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">:</span> string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">return</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>baseDir<span class=\"token punctuation\">,</span> collection<span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.yaml</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>First, we retrieve the cache key for a given document. For this, we\nconcatenate the collection (folder) name and ID of the required\ndocument. We then use this key to access the document in the cache. If\nit is not there, we need to load it from the file system and then store\nit in the cache under our cache key.</p>\n<p>For parsing YAML files, we will use js-yaml\n(<a href=\"https://www.npmjs.com/package/js-yaml\" target=\"_blank\" rel=\"nofollow noopener\">https://www.npmjs.com/package/js-yaml</a>) library.</p>\n<p>For caching collections, a simple dictionary of arrays is enough. We\ndon't need TTL in this case, because we will query collections more\noften than actual documents and actual content in memory is rather\nsmall.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span><span class=\"token function\"> getCollection</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">collection<span class=\"token punctuation\">:</span> string</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Promise<span class=\"token operator\">&lt;</span>string<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">if</span><span class=\"token function\"> </span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">!</span>collectionCache<span class=\"token punctuation\">[</span>collection<span class=\"token punctuation\">]</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        collectionCache<span class=\"token punctuation\">[</span>collection<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span><span class=\"token function\"> </span><span class=\"token punctuation\">(</span><span class=\"token keyword\">await</span><span class=\"token function\"> glob</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>baseDir<span class=\"token punctuation\">,</span> collection<span class=\"token punctuation\">,</span> <span class=\"token string\">'*.${yaml}'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n            <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">p </span><span class=\"token operator\">=></span><span class=\"token function\"> </span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n\n                id<span class=\"token punctuation\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">basename</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">extname</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n\n                path<span class=\"token punctuation\">:</span> p\n\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">return</span> collectionCache<span class=\"token punctuation\">[</span>collection<span class=\"token punctuation\">]</span><span class=\"token operator\">!</span>\n\n        <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">f </span><span class=\"token operator\">=></span> f<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Text editor to the rescue</h2>\n<p>Because we have all documents nicely accessible from the file system, it\nwould be a shame not to support changes outside of the application. This\nway, it is possible to handle usability patterns, that we are not\ndirectly supporting in the application. E.g., as we said previously, we\nwill be able to copy invoices before adding this feature into the\napplication.</p>\n<p>For this, we are going to introduce file watcher using chokidar\n(<a href=\"https://www.npmjs.com/package/chokidar\" target=\"_blank\" rel=\"nofollow noopener\">[https://www.npmjs.com/package/chokidar]{.underline}</a>)\nlibrary.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">watcher <span class=\"token operator\">=</span> chokidar<span class=\"token punctuation\">.</span><span class=\"token function\">watch</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">**/*.yaml</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> cwd<span class=\"token punctuation\">:</span> baseDir <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nwatcher\n\n    <span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'add'</span><span class=\"token punctuation\">,</span><span class=\"token parameter\"> file </span><span class=\"token operator\">=></span><span class=\"token function\"> onChange</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">,</span> <span class=\"token string\">'add'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'unlink'</span><span class=\"token punctuation\">,</span><span class=\"token parameter\"> file </span><span class=\"token operator\">=></span><span class=\"token function\"> onChange</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">,</span> <span class=\"token string\">'unlink'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'change'</span><span class=\"token punctuation\">,</span><span class=\"token parameter\"> file </span><span class=\"token operator\">=></span><span class=\"token function\"> onChange</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">,</span> <span class=\"token string\">'change'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span><span class=\"token function\"> onChange</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span> changeType<span class=\"token punctuation\">:</span> <span class=\"token string\">'add'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'unlink'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'change'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">const</span> collection <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">basename</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">dirname</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">basename</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">extname</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">    invalidateDocumentInCache</span><span class=\"token punctuation\">(</span>collection<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">,</span> changeType <span class=\"token operator\">!==</span> <span class=\"token string\">'change'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span><span class=\"token function\"> invalidateDocumentInCache</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">collection<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span> invalidateCollectionCache<span class=\"token punctuation\">:</span> boolean</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">const</span> documentCacheKey <span class=\"token operator\">=</span><span class=\"token function\"> getDocumentCacheKey</span><span class=\"token punctuation\">(</span>collection<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    documentCache<span class=\"token punctuation\">.</span><span class=\"token function\">del</span><span class=\"token punctuation\">(</span>documentCacheKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">if</span><span class=\"token function\"> </span><span class=\"token punctuation\">(</span><span class=\"token parameter\">collectionCache <span class=\"token operator\">&amp;&amp;</span> invalidateCollectionCache</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n        collectionCache<span class=\"token punctuation\">[</span>collection<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>In case of detecting a change to a YAML file, we remove it from the\nnode-cache. If the file is removed, added, or renamed (add + unlink),\nthen we also clear the whole collection in the collection cache.</p>\n<h2>Let`s search</h2>\n<p>Finally, we have everything prepared for doing an actual querying. We\nare going to do it on two levels. Query by ID and by content. We will\nuse the micromatch\n(<a href=\"https://www.npmjs.com/package/micromatch\" target=\"_blank\" rel=\"nofollow noopener\">[https://www.npmjs.com/package/micromatch]{.underline}</a>)\nlibrary for querying by ID.</p>\n<p>async function getAllIds(query?: IdQuery): Promise&#x3C;string[]> {</p>\n<p>    let ids = await getCollection(collectionName);</p>\n<p>    if (query &#x26;&#x26; query.id) {</p>\n<p>        ids = ids.filter(d => micromatch.isMatch(d, query.id!));</p>\n<p>    }</p>\n<p>    return orderBy(ids, 'id');</p>\n<p>}</p>\n<p>Micromatch enables us to run simple queries based on ID. E.g., in the\ncase of invoices, each ID consists of year and number in the specific\nyear, so it looks like this \"201933\". To get all invoices created in a\nspecific year, we can use '${year}*' query.</p>\n<p>For querying by content of files, we are going to use simple filtering.</p>\n<p>let docs = await Promise.all(collection.map(doc =>.getDocument(collectionName, doc)));</p>\n<p>if (query &#x26;&#x26; query.where) {</p>\n<p>    docs = docs.filter(query.where)</p>\n<p>}</p>\n<h2>Save it &#x26; load it  </h2>\n<p>To keep local and remote Git repositories in sync, we need to pull and\npush regularly. For a single page application, the best time to pull is\nduring page refresh. It is possible to push after each change, so the\nremote repository is updated as soon as possible. For actual Git\nhandling, we are going to use simple-git\n(<a href=\"https://www.npmjs.com/package/simple-git\" target=\"_blank\" rel=\"nofollow noopener\">[https://www.npmjs.com/package/simple-git]{.underline}</a>)\nlibrary, which makes git operations easy.</p>\n<p>async function pull(): Promise<any> {</p>\n<p>    await ensureRepo();</p>\n<p>    await repo!.pull();</p>\n<p>}</p>\n<p>async function commitAndPush(message: string): Promise<any> {</p>\n<p>    await ensureRepo();</p>\n<p>    await repo!.add('.');</p>\n<p>    var commitRes = await repo!.commit(message);</p>\n<p>    var pushRes = await repo!.push();</p>\n<p>}</p>\n<p>async function ensureRepo() {</p>\n<p>    if (!repo) {</p>\n<p>        repo = simplegit(db.dir);</p>\n<p>    }</p>\n<p>}</p>\n<p>And then in actual update code:</p>\n<p>async function update(invoice: InvoiceUpdateModel): Promise<InvoiceDocument> {</p>\n<p>    let invoiceDocument = await db.invoices.single(invoice.id);</p>\n<p>    invoiceDocument = { ...invoiceDocument, ...invoice };</p>\n<p>    invoiceDocument = await db.invoices.update(invoiceDocument);</p>\n<p>    await repoService.commitAndPush(<code class=\"language-text\">invoice(${invoice.id}):updated</code>);</p>\n<p>    return invoiceDocument;</p>\n<p>}</p>\n<blockquote>\n</blockquote>\n<h2>Conclusion</h2>\n<p>I must say that I`m happy with the result. For this specific use case,\ngit works quite nice as a database for application data. Of course, the\nperformance is much lower compared to common database solutions. The\nwhole concept would also be far from ideal in case of an application\nhosted on a remote server because it would make dealing with conflicts\nmuch more difficult. But on the other hand, it is really simple, cheap\nand it gives us the ability to do quick hacking of documents.</p>\n<p>You can access the whole code of the invoicing application here\n<a href=\"https://github.com/pruttned/owl-invoice\" target=\"_blank\" rel=\"nofollow noopener\">https://github.com/pruttned/owl-invoice</a></p>","timeToRead":8,"frontmatter":{"date":"May 04, 2019","path":"/blog/my-first-post","title":"My first blog post","featuredImage":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAACToAAAk6AGCYwUcAAACXUlEQVQozyWSWU9TQRiG+59MBBUTKC2lgBRaC0QKQmVTyxLUlogFFCOGrYWWpQXK6YEup6cbxcomS+VCSIjxQhO98Lc8TuvFm3fmy+T53m9mNPNLbhaWJ/D4JvH4J1n0uUvyrk6xvP5O1N2s5j6h/PhL9Oa30B8iwiPC5aufhC6/Ezi9wn9QYDFziGZdWmBj10covia0zmZkhYDsZT3sYWVrlrkFJ/NhCfn6F9LlDaHCNcu5I6alKJNBCafHz+D0DF0vXVj7BtBsxVaR0yFi+SjKkUriOEnsQEFObRLYnmVr14tv28vk6hpTgSBv/Cv0OF3UtrTR8KgdvcVKdbOFygYTFcZ6NJIaIJqTSRwqJL+kSJ1nyV7mkbJhPnjfshic46N/Bvuwg/7X4zxzu3nyyonB2sodfS0VtfXcM9QJryutNTt7YeIHMdQSbA/1NCNSqvS9cFCm1aE1WahqNHPrfiVVDxqxPXfQMTiIzeGgxvKQuwJWrjNQXq0XDQxFoET8c1RAEqgnKvG8jHdtmvZOK3WNRoxmE7Z+O/ahAYbHR3CMDdHa20tLj5BwvcVSApUJYLmuBk20CCumu8iRKuyT/ppH3pPpe/qYsYkRIkdJst9OyFzuky2kCGc3cb13Yem2Y+nqxtzVha7JXILe1urRhBJryJktovkI8cMYCZFSOVbYzW2TPE2SviheQ1LUFXFGFhNIbETmGZ0YpamjE5OtQ8iGtrHpf8KgvCC+i1+86gaRXBjlQCQ+SZA8z5A8y6CepUsq7tXTdKmp8nmHjdiSGH+Y+ta2kozWFnTNZv4BB3rTB39fVdIAAAAASUVORK5CYII=","aspectRatio":2.2666666666666666,"src":"/static/108e4ccc061736c3751c0aa8da74bd8d/af144/p1.png","srcSet":"/static/108e4ccc061736c3751c0aa8da74bd8d/7c0ed/p1.png 200w,\n/static/108e4ccc061736c3751c0aa8da74bd8d/647de/p1.png 400w,\n/static/108e4ccc061736c3751c0aa8da74bd8d/af144/p1.png 800w,\n/static/108e4ccc061736c3751c0aa8da74bd8d/ba299/p1.png 1200w,\n/static/108e4ccc061736c3751c0aa8da74bd8d/41d74/p1.png 1360w","sizes":"(max-width: 800px) 100vw, 800px"}}},"featuredImageBy":"Brina Blum","featuredImageByUrl":"https://unsplash.com/@brina_blum?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText","featuredImageSite":"Unsplash","featuredImageSiteUrl":"https://unsplash.com/s/photos/git?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText"}}},"pageContext":{"isCreatedByStatefulCreatePages":false}}}