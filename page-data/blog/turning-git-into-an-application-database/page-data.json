{"componentChunkName":"component---src-templates-blog-page-js","path":"/blog/turning-git-into-an-application-database","result":{"data":{"markdownRemark":{"html":"<p>Today when you are creating an application, you have many options for a database to choose from.<br>\nWhat you might not realize is that you could consider Git as one of the options with some great advantages. Why and how would you do that? Well, read ahead.</p>\n<!-- end -->\n<p>Recently I was creating a simple invoicing application with my brother as a personal project for our needs. From the very beginning, we intended to run our application locally in a single-user mode, but we required to be able to access data from multiple places.</p>\n<p>In the past, we discussed the possibilities of using file system along with Git to create a simple, yet powerful database, so we decided to use this opportunity to make a proof of concept of this idea. </p>\n<h2>Why Git?</h2>\n<p>Let’s look at the benefits of using Git backed filesystem as an application database.</p>\n<ul>\n<li>History - Let’s face it, managing history in common database is usually not fun. You’ll end up with tables full of records where you must check dates just to get the currently active record. Or you must move records to historical tables. Either way, it is tedious. But with Git, you’ll get history basically for free. You are even able to compare versions, and you also know who, when, and why did the change.</li>\n<li>Hosting for free – Today, you can create a private repo in Bitbucket and Github without any costs. Compared to ordinary database free hostings, there are no row constraints, no read/write constraints, and I consider both Github and Bitbucket reliable providers.</li>\n<li>Human readable data store - By storing data in plain text files, you can read and even edit data with your favorite text editor. Thanks to this, you can quickly hack some data, or rapidly prototype new features. E.g., you need to clone an old invoice, and you still had no time to implement this feature into your application? No problem, simply copy the file, open your favorite text editor, and you are done. It’s much easier than in most database admin tools.</li>\n<li>Distributed and disconnected database - Great thing about Git is its distributed nature. Each local repository contains the full history. If one of the repositories dies, it doesn’t usually mean a loss of data. It is also possible to work in offline mode without any additional headaches.</li>\n<li>Merging of conflicts - When two users change the same entity, there must be a conflict resolution. That often means that either the later change wins or the first one. Git, on the other hand, gives users the ability to merge conflicts manually and in many cases, can merge changes automatically.</li>\n</ul>\n<p>Now, when we know what the benefits of a Git application database are, let us dive into implementation.</p>\n<h2>How to store documents</h2>\n<p>First, we need to decide how we are going to model our database. We will use folders for collections and files for documents.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 680px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c70d4d5a316e38e38c975b9fe32a1eac/2bcdc/fs-hierarchy.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 41.06870229007634%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAYAAAD5nd/tAAAACXBIWXMAACToAAAk6AGCYwUcAAABkUlEQVQoz22RCW+bQBSE+f+/p1KTtulF4/gA19jOUQVsjgWcGGPA3AtM365rtVX70Ag0bzV8Awr+M3Vbgg8teN+g5iW6vkPbNdJvf3kNr+XZYRj+kuK6LlRVhWmasEwLHnOxP7xgvV5jsViA+S4Fn8Mdx4amafA8D01XUdq/MArnHHmeS9VVjZa3yMoEx+yA5BTLZxEo6NI8lv6pSlHxQvDR1UuJFpKwKApkWXauWtcoywpFc4KxnUH/McbCnMLYzBBlO7gHCytbx3fyllsdhqWdtdFg7h5lqMIYw3w+R9/3iKIIYRDKt4uwO0PFZPUNk/tb7CnQO2yhP40xMr5i9nCHMe2Epg8jWLsnCuRQLt0F7mWK+gQWbxCkDsLUhZ/YVP2Il9SHF1vSDxLaZS7tHbDjFn5sExQRXv6OGEEpPrSorC5vcH37Bh8mb/FJe4fXJIC9f8banWO0/IKPs2vcTK/wWXuPlaPj0TfAu/Z34J/BnNCDmMhI4s4iG2WTIy1jhEePxMj3pELSLmF4zUL0Q4+f4ApX47hdLQIAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"file system hierarchy\"\n        title=\"file system hierarchy\"\n        src=\"/static/c70d4d5a316e38e38c975b9fe32a1eac/5e3e6/fs-hierarchy.png\"\n        srcset=\"/static/c70d4d5a316e38e38c975b9fe32a1eac/924ad/fs-hierarchy.png 170w,\n/static/c70d4d5a316e38e38c975b9fe32a1eac/6103d/fs-hierarchy.png 340w,\n/static/c70d4d5a316e38e38c975b9fe32a1eac/5e3e6/fs-hierarchy.png 680w,\n/static/c70d4d5a316e38e38c975b9fe32a1eac/89b07/fs-hierarchy.png 1020w,\n/static/c70d4d5a316e38e38c975b9fe32a1eac/2bcdc/fs-hierarchy.png 1310w\"\n        sizes=\"(max-width: 680px) 100vw, 680px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>This way, it is easy to collect all the entities stored in one collection, and it is also more readable for a human. We are going to use a non-bare repository, so we will be able to access files directly, which I consider to be a big advantage.</p>\n<p>Let’s point out here an interesting article <a href=\"https://www.kenneth-truyers.net/2016/10/13/git-nosql-database/\" target=\"_blank\" rel=\"nofollow noopener\">https://www.kenneth-truyers.net/2016/10/13/git-nosql-database/</a> that is also dealing with the concept of using Git as a database, but it is using bare repositories.</p>\n<p>To speed up lookups, we are going to store document ID directly in the file name. This way, it is not necessary to open a file to get the ID. And it is again more readable for a human. It would also be possible to store more fields in the file name and thus make a sort of index.</p>\n<p>As a file format for document files, we will use YAML. YAML is great for serializing data while keeping them human-readable, so checking diffs in the Git history will be easier for us.</p>\n<h2>Let’s have some performance</h2>\n<p>Ok, so now when we have our file structure, to have any sense of speed, we need caching. We are going to do caching on two levels. First, we will cache collection and then also individual documents.</p>\n<p>Caching of individual documents is more interesting, so let us start with that. We should better not keep documents in memory forever, but rather they should have TTL (time to live) specified. For actual implementation, we will use <a href=\"https://www.npmjs.com/package/node-cache\" target=\"_blank\" rel=\"nofollow noopener\">node-cache</a> library.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getDocument</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">collection<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">:</span> string</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Promise<span class=\"token operator\">&lt;</span>any<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> documentCacheKey <span class=\"token operator\">=</span> <span class=\"token function\">getDocumentCacheKey</span><span class=\"token punctuation\">(</span>collection<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> document <span class=\"token operator\">=</span> documentCache<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>documentCacheKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>document<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> file <span class=\"token operator\">=</span> <span class=\"token function\">getDocumentPath</span><span class=\"token punctuation\">(</span>collection<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> fileContent <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">readFile</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">,</span> <span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    document <span class=\"token operator\">=</span> yaml<span class=\"token punctuation\">.</span><span class=\"token function\">safeLoad</span><span class=\"token punctuation\">(</span>fileContent<span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">(</span>document <span class=\"token keyword\">as</span> any<span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> id<span class=\"token punctuation\">;</span>\n    documentCache<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>documentCacheKey<span class=\"token punctuation\">,</span> document<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> document<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">getDocumentCacheKey</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">collection<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">:</span> string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>collection<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">-</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">getDocumentPath</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">collection<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">:</span> string</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>baseDir<span class=\"token punctuation\">,</span> collection<span class=\"token punctuation\">,</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.yaml</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>First, we retrieve the cache key for a given document. For this, we concatenate the collection (folder) name and ID of the required document. We then use this key to access the document in the cache. If it is not there, we need to load it from the file system and then store it in the cache under our cache key.</p>\n<p>For parsing YAML files, we will use <a href=\"https://www.npmjs.com/package/js-yaml\" target=\"_blank\" rel=\"nofollow noopener\">js-yaml</a> library.</p>\n<p>For caching collections, a simple dictionary of arrays is enough. We don’t need TTL in this case, because we will query collections more often than actual documents and actual content in memory is rather small.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getCollection</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">collection<span class=\"token punctuation\">:</span> string</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Promise<span class=\"token operator\">&lt;</span>string<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>collectionCache<span class=\"token punctuation\">[</span>collection<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    collectionCache<span class=\"token punctuation\">[</span>collection<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span>\n      <span class=\"token punctuation\">(</span><span class=\"token keyword\">await</span> <span class=\"token function\">glob</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span>baseDir<span class=\"token punctuation\">,</span> collection<span class=\"token punctuation\">,</span> <span class=\"token string\">'*.${yaml}'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">p</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n          id<span class=\"token punctuation\">:</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">basename</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">extname</span><span class=\"token punctuation\">(</span>p<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n          path<span class=\"token punctuation\">:</span> p\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> collectionCache<span class=\"token punctuation\">[</span>collection<span class=\"token punctuation\">]</span><span class=\"token operator\">!</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">f</span> <span class=\"token operator\">=></span> f<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Text editor to the rescue</h2>\n<p>Because we have all documents nicely accessible from the file system, it would be a shame not to support changes outside of the application. This way, it is possible to handle usability patterns, that we are not directly supporting in the application. E.g., as we said previously, we will be able to copy invoices before adding this feature into the application.</p>\n<p>For this, we are going to introduce file watcher using <a href=\"https://www.npmjs.com/package/chokidar\" target=\"_blank\" rel=\"nofollow noopener\">chokidar</a> library.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">watcher <span class=\"token operator\">=</span> chokidar<span class=\"token punctuation\">.</span><span class=\"token function\">watch</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">**/*.yaml</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> cwd<span class=\"token punctuation\">:</span> baseDir <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nwatcher\n  <span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'add'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">file</span> <span class=\"token operator\">=></span> <span class=\"token function\">onChange</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">,</span> <span class=\"token string\">'add'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'unlink'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">file</span> <span class=\"token operator\">=></span> <span class=\"token function\">onChange</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">,</span> <span class=\"token string\">'unlink'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'change'</span><span class=\"token punctuation\">,</span> <span class=\"token parameter\">file</span> <span class=\"token operator\">=></span> <span class=\"token function\">onChange</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">,</span> <span class=\"token string\">'change'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">onChange</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span> changeType<span class=\"token punctuation\">:</span> <span class=\"token string\">'add'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'unlink'</span> <span class=\"token operator\">|</span> <span class=\"token string\">'change'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> collection <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">basename</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">.</span><span class=\"token function\">dirname</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">basename</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">.</span><span class=\"token function\">extname</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">invalidateDocumentInCache</span><span class=\"token punctuation\">(</span>collection<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">,</span> changeType <span class=\"token operator\">!==</span> <span class=\"token string\">'change'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">invalidateDocumentInCache</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">collection<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">:</span> string<span class=\"token punctuation\">,</span>\n  invalidateCollectionCache<span class=\"token punctuation\">:</span> boolean</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> documentCacheKey <span class=\"token operator\">=</span> <span class=\"token function\">getDocumentCacheKey</span><span class=\"token punctuation\">(</span>collection<span class=\"token punctuation\">,</span> id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  documentCache<span class=\"token punctuation\">.</span><span class=\"token function\">del</span><span class=\"token punctuation\">(</span>documentCacheKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>collectionCache <span class=\"token operator\">&amp;&amp;</span> invalidateCollectionCache<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    collectionCache<span class=\"token punctuation\">[</span>collection<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>In case of detecting a change to a YAML file, we remove it from the node-cache. If the file is removed, added, or renamed (add + unlink), then we also clear the whole collection in the collection cache.</p>\n<h2>Let’s search</h2>\n<p>Finally, we have everything prepared for doing an actual querying. We are going to do it on two levels. Query by ID and by content. We will use the <a href=\"https://www.npmjs.com/package/micromatch\" target=\"_blank\" rel=\"nofollow noopener\">micromatch</a> library for querying by ID.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">getAllIds</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">query<span class=\"token operator\">?</span><span class=\"token punctuation\">:</span> IdQuery</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Promise<span class=\"token operator\">&lt;</span>string<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> ids <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">getCollection</span><span class=\"token punctuation\">(</span>collectionName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>query <span class=\"token operator\">&amp;&amp;</span> query<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    ids <span class=\"token operator\">=</span> ids<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">d</span> <span class=\"token operator\">=></span> micromatch<span class=\"token punctuation\">.</span><span class=\"token function\">isMatch</span><span class=\"token punctuation\">(</span>d<span class=\"token punctuation\">,</span> query<span class=\"token punctuation\">.</span>id<span class=\"token operator\">!</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">orderBy</span><span class=\"token punctuation\">(</span>ids<span class=\"token punctuation\">,</span> <span class=\"token string\">'id'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Micromatch enables us to run simple queries based on ID. E.g., in the case of invoices, each ID consists of year and number in the specific year, so it looks like this \"201933\". To get all invoices created in a specific year, we can use \"${year}*\" query.</p>\n<p>For querying by content of files, we are going to use simple filtering.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">let</span> docs <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>\n    collection<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">doc</span> <span class=\"token operator\">=></span> doc<span class=\"token punctuation\">.</span><span class=\"token function\">getDocument</span><span class=\"token punctuation\">(</span>collectionName<span class=\"token punctuation\">,</span> doc<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>query <span class=\"token operator\">&amp;&amp;</span> query<span class=\"token punctuation\">.</span>where<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  docs <span class=\"token operator\">=</span> docs<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">.</span>where<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Save it &#x26; load it  </h2>\n<p>To keep local and remote Git repositories in sync, we need to pull and push regularly. For a single page application, the best time to pull is during page refresh. It is possible to push after each change, so the remote repository is updated as soon as possible. For actual Git handling, we are going to use <a href=\"https://www.npmjs.com/package/simple-git\" target=\"_blank\" rel=\"nofollow noopener\">simple-git</a> library, which makes git operations easy.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">pull</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Promise<span class=\"token operator\">&lt;</span>any<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">await</span> <span class=\"token function\">ensureRepo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">await</span> repo<span class=\"token operator\">!</span><span class=\"token punctuation\">.</span><span class=\"token function\">pull</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">commitAndPush</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">message<span class=\"token punctuation\">:</span> string</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Promise<span class=\"token operator\">&lt;</span>any<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">await</span> <span class=\"token function\">ensureRepo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">await</span> repo<span class=\"token operator\">!</span><span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> commitRes <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> repo<span class=\"token operator\">!</span><span class=\"token punctuation\">.</span><span class=\"token function\">commit</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> pushRes <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> repo<span class=\"token operator\">!</span><span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">ensureRepo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>repo<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    repo <span class=\"token operator\">=</span> <span class=\"token function\">simplegit</span><span class=\"token punctuation\">(</span>db<span class=\"token punctuation\">.</span>dir<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>And then in actual update code:  </p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">invoice<span class=\"token punctuation\">:</span> InvoiceUpdateModel</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span> Promise<span class=\"token operator\">&lt;</span>InvoiceDocument<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> invoiceDocument <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> db<span class=\"token punctuation\">.</span>invoices<span class=\"token punctuation\">.</span><span class=\"token function\">single</span><span class=\"token punctuation\">(</span>invoice<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  invoiceDocument <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>invoiceDocument<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>invoice <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  invoiceDocument <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> db<span class=\"token punctuation\">.</span>invoices<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>invoiceDocument<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">await</span> repoService<span class=\"token punctuation\">.</span><span class=\"token function\">commitAndPush</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">invoice(</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>invoice<span class=\"token punctuation\">.</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">):updated</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> invoiceDocument<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Conclusion</h2>\n<p>I must say that I’m happy with the result. For this specific use case, git works quite nice as a database for application data. Of course, the performance is much lower compared to common database solutions. The whole concept would also be far from ideal in case of an application hosted on a remote server because it would make dealing with conflicts much more difficult. But on the other hand, it is really simple, cheap and it gives us the ability to do quick hacking of documents.</p>\n<p>You can access the whole code of the invoicing application here <a href=\"https://github.com/pruttned/owl-invoice\" target=\"_blank\" rel=\"nofollow noopener\">https://github.com/pruttned/owl-invoice</a></p>","timeToRead":7,"frontmatter":{"date":"December 28, 2019","path":"/blog/turning-git-into-an-application-database","title":"Turning Git into an application database","featuredImage":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAEEAwX/xAAWAQEBAQAAAAAAAAAAAAAAAAACAAH/2gAMAwEAAhADEAAAAaMaVh5QhX//xAAaEAADAAMBAAAAAAAAAAAAAAAAAQIDEiEy/9oACAEBAAEFAq5NPIp3oRfk/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAGhAAAgIDAAAAAAAAAAAAAAAAAAEQESExUf/aAAgBAQAGPwLCs4bcOP/EABsQAAICAwEAAAAAAAAAAAAAAAARASEQMXGh/9oACAEBAAE/IYWNGkL1kvvF8xJ//9oADAMBAAIAAwAAABCnH//EABURAQEAAAAAAAAAAAAAAAAAAAEQ/9oACAEDAQE/EGf/xAAWEQEBAQAAAAAAAAAAAAAAAAABEBH/2gAIAQIBAT8QHJ//xAAbEAACAgMBAAAAAAAAAAAAAAAAARExIVFxof/aAAgBAQABPxBDdBSM+gVCQ6T2V0oeoWP/2Q==","aspectRatio":2.2666666666666666,"src":"/static/b90ca3d688fc9259a019732bc0207417/bc3a8/featured.jpg","srcSet":"/static/b90ca3d688fc9259a019732bc0207417/d278e/featured.jpg 200w,\n/static/b90ca3d688fc9259a019732bc0207417/8539d/featured.jpg 400w,\n/static/b90ca3d688fc9259a019732bc0207417/bc3a8/featured.jpg 800w,\n/static/b90ca3d688fc9259a019732bc0207417/81ef8/featured.jpg 1200w,\n/static/b90ca3d688fc9259a019732bc0207417/10fb1/featured.jpg 1360w","sizes":"(max-width: 800px) 100vw, 800px"}}},"featuredImageBy":"Brina Blum","featuredImageByUrl":"https://unsplash.com/@brina_blum?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText","featuredImageSite":"Unsplash","featuredImageSiteUrl":"https://unsplash.com/s/photos/git?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText"}}},"pageContext":{"isCreatedByStatefulCreatePages":false}}}