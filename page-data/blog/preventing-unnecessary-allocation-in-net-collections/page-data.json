{"componentChunkName":"component---src-templates-blog-page-js","path":"/blog/preventing-unnecessary-allocation-in-net-collections","result":{"data":{"markdownRemark":{"html":"<p>.NET is doing a really good job in the case of memory management, and usually, you don’t have to think about it at all. But if you are creating an application where performance really matters, for instance, a game in Unity, then it is important to have allocations in check. Sometimes you will be surprised how a rather innocently looking code could do a lot of allocations and mess with the performance. Let’s look into a few such cases.</p>\n<!-- end -->\n<h2>Heap vs. Stack</h2>\n<p>Before we jump straight to examples, let’s first take a quick detour to grasp some basics of memory management in .NET.</p>\n<p>In .NET, we have two kinds of types - Reference types (class) and value types (e.g., struct).</p>\n<p>Reference types are allocated on the heap, while value types (when used for parameters, local variables, or return values) are allocated on the stack.</p>\n<p>You can perceive stack as a LIFO (last in first out) structure of blocks (stack frames) containing the method being executed, its parameters, and local variables. Each time a method execution finishes, its frame is removed from the top of the stack. This removal is done outside of .NET garbage collection.</p>\n<p>Heap is a memory place where you can allocate much bigger memory blocks and keep them alive as long as you need them. Garbage collection is responsible for freeing memory allocated on the heap. Disadvantage is that the garbage collection is slower then removing objects from the stack.</p>\n<p>When we are writing a performance-critical code, we should prevent unnecessary heap allocations. </p>\n<h2>IEnumerable and heap allocations</h2>\n<p>Suppose that we are creating a custom collection, and we would like to be able to enumerate over it. For our example, we are going to create a simple wrapper over List&#x3C;float> whose purpose is to prevent negative numbers in the collection.</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">NonNegativeCollection</span> <span class=\"token punctuation\">:</span> <span class=\"token class-name\">IEnumerable</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">float</span><span class=\"token operator\">></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> List<span class=\"token operator\">&lt;</span><span class=\"token keyword\">float</span><span class=\"token operator\">></span> mItems <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token generic-method\"><span class=\"token function\">List</span><span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">float</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span> <span class=\"token keyword\">value</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> mItems<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span>Math<span class=\"token punctuation\">.</span><span class=\"token function\">Abs</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">value</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token class-name\">IEnumerator</span> IEnumerable<span class=\"token punctuation\">.</span><span class=\"token function\">GetEnumerator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> mItems<span class=\"token punctuation\">.</span><span class=\"token function\">GetEnumerator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> IEnumerator<span class=\"token operator\">&lt;</span><span class=\"token keyword\">float</span><span class=\"token operator\">></span> <span class=\"token function\">GetEnumerator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> mItems<span class=\"token punctuation\">.</span><span class=\"token function\">GetEnumerator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>We have an internal list of items, Add method that is doing all the hard work and methods for implementing IEnumerable&#x3C;float>.</p>\n<p>Now let’s put our new and shiny collection to good use.</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token keyword\">var</span> collection <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">NonNegativeCollection</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token operator\">-</span><span class=\"token number\">1.1f</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1.1f</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">// game loop</span>\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> sum <span class=\"token operator\">=</span> <span class=\"token number\">0f</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> item <span class=\"token keyword\">in</span> collection<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        sum <span class=\"token operator\">+=</span> item<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>We are creating an instance of our collection filled with numbers, and then we are computing the sum of them (yes without Linq ). We are doing this multiple times to simulate a game loop or a complex computation. How many allocations would you expect to be happening in this simple code? There is, of course, the obvious one, the allocation of the NonNegativeCollection class. But it happens outside of the game loop. Let’s open a memory profiler to check if there are any other allocations.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 680px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b8754d87aa2d4fb7496c279a9dd59172/dc8ef/image2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 19.21546333143832%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAACToAAAk6AGCYwUcAAAA7ElEQVQY01XMQVPCMBAF4P4HQbC1UYaGJIW2CBT0IpQC4wVxUC9OKOWgo4L+/9tzk548fPN2XjbrpONbxMkNhAwhVRdhN7IZcAHekf8EXCKi3VE6wTAdQ9BeRyiaJ5a549wNEhijOMQwoseeQqI4OPMQMLfiGxfUuVbba9i9Hm9VPTEZtq/hXD28Qz0dITZfEI8VufkGW5bw8gL+cg+2OqAx06jNCpxne5xR8vUnvEVpuzp1zbyEvyjguPMdou0R/ZcfxNsTEsrB6y/6JH4+Qa4/0FrRh+kbavcadXN4qnE513Czajaa2Q4s1/gDeZKCBjBVFpgAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"memory profiler\"\n        title=\"memory profiler\"\n        src=\"/static/b8754d87aa2d4fb7496c279a9dd59172/5e3e6/image2.png\"\n        srcset=\"/static/b8754d87aa2d4fb7496c279a9dd59172/924ad/image2.png 170w,\n/static/b8754d87aa2d4fb7496c279a9dd59172/6103d/image2.png 340w,\n/static/b8754d87aa2d4fb7496c279a9dd59172/5e3e6/image2.png 680w,\n/static/b8754d87aa2d4fb7496c279a9dd59172/89b07/image2.png 1020w,\n/static/b8754d87aa2d4fb7496c279a9dd59172/2f8d2/image2.png 1360w,\n/static/b8754d87aa2d4fb7496c279a9dd59172/dc8ef/image2.png 1759w\"\n        sizes=\"(max-width: 680px) 100vw, 680px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>As you can see, apart from expected NonNegativeCollection allocation, we have 1000 allocations from GetEnumerator method. One for each iteration in the game loop.</p>\n<p>We must be doing something wrong.</p>\n<p>We are returning an enumerator from our inner mItems List in the GetEnumerator method. If we check the type of this enumerator, we can see that it is a structure. So why do we see allocations on the heap? The reason for this is boxing. It happens each time we convert a value type to System.Object, or to an interface. In our GetEnumerator implementation, we are returning the enumerator as an IEnumerator&#x3C;float>. Because of this, the enumerator instance is moved onto the heap.</p>\n<h3>Let’s fix it</h3>\n<p>The fix is rather simple. According to <a href=\"https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/foreach-in\" target=\"_blank\" rel=\"nofollow noopener\">documentation on foreach loop</a>, we don’t have to implement IEnumerable if we wish to support foreach loop. All we need is to have a public parameterless GetEnumerator method that returns an enumerator. Let’s change GetEnumerator to implicit interface implementation and provide another GetEnumerator method that returns List&#x3C;float>.Enumerator. Our resulting code looks like this.</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">NonNegativeCollection</span> <span class=\"token punctuation\">:</span> <span class=\"token class-name\">IEnumerable</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">float</span><span class=\"token operator\">></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//...</span>\n    <span class=\"token keyword\">public</span> List<span class=\"token operator\">&lt;</span><span class=\"token keyword\">float</span><span class=\"token operator\">></span><span class=\"token punctuation\">.</span><span class=\"token class-name\">Enumerator</span> <span class=\"token function\">GetEnumerator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> mItems<span class=\"token punctuation\">.</span><span class=\"token function\">GetEnumerator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    IEnumerator<span class=\"token operator\">&lt;</span><span class=\"token keyword\">float</span><span class=\"token operator\">></span> IEnumerable<span class=\"token operator\">&lt;</span><span class=\"token keyword\">float</span><span class=\"token operator\">></span><span class=\"token punctuation\">.</span><span class=\"token function\">GetEnumerator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> \n      mItems<span class=\"token punctuation\">.</span><span class=\"token function\">GetEnumerator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>In reality, we could even remove the whole IEnumerable&#x3C;float> implementation and still be able to use foreach loop on our collection class, but I prefer to keep it there to make it explicit that the class supports enumeration.</p>\n<p>If we run the memory profiler again, we would see that the extra heap allocations are gone (there is no boxing anymore), and we have gained some precious performance.</p>\n<h2>Casting collection to IEnumerable</h2>\n<p>Let’s say that we want to make our sum computation reusable and to support also other collection types. Therefore we will move the sum computation to a separate method, and we will define its parameter as IEnumerable&#x3C;float>.</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">float</span> <span class=\"token function\">Sum</span><span class=\"token punctuation\">(</span>IEnumerable<span class=\"token operator\">&lt;</span><span class=\"token keyword\">float</span><span class=\"token operator\">></span> collection<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> sum <span class=\"token operator\">=</span> <span class=\"token number\">0f</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> item <span class=\"token keyword\">in</span> collection<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        sum <span class=\"token operator\">+=</span> item<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> sum<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>After running the memory profiler again, we see that we are again doing heap allocations. It is happening because we are casting the input collection to IEnumerable&#x3C;float>. Therefore we are again using IEnumerable&#x3C;float>.GetEnumerator() method and thus doing boxing.</p>\n<p>How to solve this case? Sadly, there is no silver bullet for this problem, at least none, that I’m aware of.</p>\n<p>We could partially solve it in multiple ways:</p>\n<ul>\n<li>We could create a separate method for each collection type, which would cause a lot of duplicate code.</li>\n<li>We could replace IEnumerable&#x3C;float> parameter with, e.g., IReadOnlyList&#x3C;float> (with Count and indexer) and use for-loop instead of foreach. But this is limiting the usage of our sum method.</li>\n<li>We could create a new IEnumerable interface that would return an Enumerator structure via generic type.</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">struct</span> NonGcEnumerator<span class=\"token operator\">&lt;</span>TEnumerator<span class=\"token punctuation\">,</span> TValue<span class=\"token operator\">></span> <span class=\"token punctuation\">:</span> IEnumerator<span class=\"token operator\">&lt;</span>TValue<span class=\"token operator\">></span>\n    <span class=\"token keyword\">where</span> TEnumerator <span class=\"token punctuation\">:</span> IEnumerator<span class=\"token operator\">&lt;</span>TValue<span class=\"token operator\">></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token class-name\">TEnumerator</span> mEnumerator<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\">TValue</span> Current <span class=\"token operator\">=></span> mEnumerator<span class=\"token punctuation\">.</span>Current<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">object</span> IEnumerator<span class=\"token punctuation\">.</span>Current <span class=\"token operator\">=></span> mEnumerator<span class=\"token punctuation\">.</span>Current<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token function\">NonGcEnumerator</span><span class=\"token punctuation\">(</span><span class=\"token class-name\">TEnumerator</span> enumerator<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        mEnumerator <span class=\"token operator\">=</span> enumerator<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">bool</span> <span class=\"token function\">MoveNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> mEnumerator<span class=\"token punctuation\">.</span><span class=\"token function\">MoveNext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">Dispose</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">Reset</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        mEnumerator<span class=\"token punctuation\">.</span><span class=\"token function\">Reset</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">INonGcEnumerable</span><span class=\"token operator\">&lt;</span>TEnumerator<span class=\"token punctuation\">,</span> TValue<span class=\"token operator\">></span>\n    <span class=\"token keyword\">where</span> TEnumerator <span class=\"token punctuation\">:</span> IEnumerator<span class=\"token operator\">&lt;</span>TValue<span class=\"token operator\">></span>\n<span class=\"token punctuation\">{</span>\n    NonGcEnumerator<span class=\"token operator\">&lt;</span>TEnumerator<span class=\"token punctuation\">,</span> TValue<span class=\"token operator\">></span> <span class=\"token function\">GetEnumerator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">NonNegativeCollection</span> <span class=\"token punctuation\">:</span> \n<span class=\"token class-name\">INonGcEnumerable</span><span class=\"token operator\">&lt;</span>List<span class=\"token operator\">&lt;</span><span class=\"token keyword\">float</span><span class=\"token operator\">></span><span class=\"token punctuation\">.</span>Enumerator<span class=\"token punctuation\">,</span> <span class=\"token keyword\">float</span><span class=\"token operator\">></span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> List<span class=\"token operator\">&lt;</span><span class=\"token keyword\">float</span><span class=\"token operator\">></span> mItems <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token generic-method\"><span class=\"token function\">List</span><span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">float</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token number\">10</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">void</span> <span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">float</span> <span class=\"token keyword\">value</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> mItems<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span>Math<span class=\"token punctuation\">.</span><span class=\"token function\">Abs</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">value</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">public</span> NonGcEnumerator<span class=\"token operator\">&lt;</span>List<span class=\"token operator\">&lt;</span><span class=\"token keyword\">float</span><span class=\"token operator\">></span><span class=\"token punctuation\">.</span>Enumerator<span class=\"token punctuation\">,</span> <span class=\"token keyword\">float</span><span class=\"token operator\">></span> <span class=\"token function\">GetEnumerator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n        <span class=\"token keyword\">new</span> <span class=\"token class-name\">NonGcEnumerator</span><span class=\"token operator\">&lt;</span>List<span class=\"token operator\">&lt;</span><span class=\"token keyword\">float</span><span class=\"token operator\">></span><span class=\"token punctuation\">.</span>Enumerator<span class=\"token punctuation\">,</span><span class=\"token keyword\">float</span><span class=\"token operator\">></span>\n \t<span class=\"token punctuation\">(</span>mItems<span class=\"token punctuation\">.</span><span class=\"token function\">GetEnumerator</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">float</span> <span class=\"token function\">Sum</span><span class=\"token punctuation\">(</span>INonGcEnumerable<span class=\"token operator\">&lt;</span>List<span class=\"token operator\">&lt;</span><span class=\"token keyword\">float</span><span class=\"token operator\">></span><span class=\"token punctuation\">.</span>Enumerator<span class=\"token punctuation\">,</span> \n<span class=\"token keyword\">float</span><span class=\"token operator\">></span> collection<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> sum <span class=\"token operator\">=</span> <span class=\"token number\">0f</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">foreach</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> item <span class=\"token keyword\">in</span> collection<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        sum <span class=\"token operator\">+=</span> item<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> sum<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This way, we can define GetEnumerator with a non-interface return type and still be able to do it a general way.</p>\n<h2>Linq</h2>\n<p>Up to this point, we were ignoring the fact that in .NET, we have a built-in method for computing the sum of items in a collection. For that, we use the Sum extension method provided by System.Linq namespace.</p>\n<p>The problem with System.Linq, in our case is, that all the methods are provided as an extension method on IEnumerable&#x3C;T> interface. E.g., the Sum method looks like this.</p>\n<div class=\"gatsby-highlight\" data-language=\"cs\"><pre class=\"language-cs\"><code class=\"language-cs\"><span class=\"token keyword\">namespace</span> System<span class=\"token punctuation\">.</span>Linq\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Enumerable</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">static</span> <span class=\"token keyword\">float</span> <span class=\"token function\">Sum</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span> IEnumerable<span class=\"token operator\">&lt;</span><span class=\"token keyword\">float</span><span class=\"token operator\">></span> source<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Therefore if we used Sum provided by Linq, we would be back on doing allocation on the heap due to boxing. In general, if you are creating a game or something similar, you should sadly forget about the entire Linq in performance-critical parts.</p>\n<h2>Conclusion</h2>\n<p>We have looked in a few cases, where .NET is doing unwanted heap allocations that are rather easy to miss. In most cases, you don’t have to care, because the garbage collector is rarely a performance bottleneck. But if you are creating a game, then you should pay attention to boxing and always check a memory profiler if you are not sure.</p>","timeToRead":6,"frontmatter":{"date":"February 09, 2020","path":"/blog/preventing-unnecessary-allocation-in-net-collections","title":"Preventing unnecessary allocation in .NET collections","featuredImage":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAGAAAAwEBAAAAAAAAAAAAAAAAAAEEAwX/xAAWAQEBAQAAAAAAAAAAAAAAAAACAAH/2gAMAwEAAhADEAAAAaMaVh5QhX//xAAaEAADAAMBAAAAAAAAAAAAAAAAAQIDEiEy/9oACAEBAAEFAq5NPIp3oRfk/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAGhAAAgIDAAAAAAAAAAAAAAAAAAEQESExUf/aAAgBAQAGPwLCs4bcOP/EABsQAAICAwEAAAAAAAAAAAAAAAARASEQMXGh/9oACAEBAAE/IYWNGkL1kvvF8xJ//9oADAMBAAIAAwAAABCnH//EABURAQEAAAAAAAAAAAAAAAAAAAEQ/9oACAEDAQE/EGf/xAAWEQEBAQAAAAAAAAAAAAAAAAABEBH/2gAIAQIBAT8QHJ//xAAbEAACAgMBAAAAAAAAAAAAAAAAARExIVFxof/aAAgBAQABPxBDdBSM+gVCQ6T2V0oeoWP/2Q==","aspectRatio":2.2666666666666666,"src":"/static/61203ea8cd19b44bf3d45aa61f0ba66e/bc3a8/featured.jpg","srcSet":"/static/61203ea8cd19b44bf3d45aa61f0ba66e/d278e/featured.jpg 200w,\n/static/61203ea8cd19b44bf3d45aa61f0ba66e/8539d/featured.jpg 400w,\n/static/61203ea8cd19b44bf3d45aa61f0ba66e/bc3a8/featured.jpg 800w,\n/static/61203ea8cd19b44bf3d45aa61f0ba66e/81ef8/featured.jpg 1200w,\n/static/61203ea8cd19b44bf3d45aa61f0ba66e/10fb1/featured.jpg 1360w","sizes":"(max-width: 800px) 100vw, 800px"},"fixed":{"src":"/static/61203ea8cd19b44bf3d45aa61f0ba66e/bc3a8/featured.jpg"}}},"featuredImageBy":"chuttersnap","featuredImageByUrl":"https://unsplash.com/@chuttersnap?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText","featuredImageSite":"Unsplash","featuredImageSiteUrl":"https://unsplash.com/s/photos/boxes?utm_source=unsplash&utm_medium=referral&utm_content=creditCopyText"}}},"pageContext":{"isCreatedByStatefulCreatePages":false}}}